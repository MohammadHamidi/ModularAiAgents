<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>هوش مصنوعی سفیران آیه ها</title>
    <link rel="stylesheet" href="/static/css/tailwind.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

    <style>

        /* Iframe-friendly full viewport */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* ===== Motion ===== */
        .message-enter {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced typing indicator with smooth animation */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .typing-indicator span:not(.typing-text) {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #6b7280;
            animation: bounce 1.4s infinite ease-in-out;
            display: inline-block;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* Smooth fade animation for typing text */
        .typing-text {
            transition: opacity 0.3s ease-in-out;
            white-space: nowrap;
        }

        .typing-text.fade {
            opacity: 0.5;
        }

        /* ===== Screenshot-matched welcome bubble glow ===== */
        .welcome-bubble {
            position: relative;
            border-radius: 18px;
            background: #ffffff;
            box-shadow: 0 10px 24px rgba(20, 20, 20, 0.10);
            overflow: visible;
            isolation: isolate;
        }

        .welcome-bubble::after {
            content: "";
            position: absolute;
            left: 14px;
            right: 14px;
            bottom: -12px;
            height: 14px;
            border-radius: 999px;
            background: linear-gradient(90deg,
                    #EAF8EF 0%,
                    #B8E2D9 12%,
                    #BADAF0 24%,
                    #CDC8DE 36%,
                    #E3B3C0 48%,
                    #F4ABA8 58%,
                    #F7CDA4 70%,
                    #F3DBAD 80%,
                    #E2C3C7 90%,
                    #F0E3EF 100%);
            filter: blur(6px);
            opacity: 0.95;
            z-index: -1;
        }

        /* Gradient behind helper text message */
        .helper-message-gradient {
            position: relative;
            overflow: visible;
        }

        .helper-message-gradient::after {
            content: "";
            position: absolute;
            left: 14px;
            right: 14px;
            bottom: -12px;
            height: 14px;
            border-radius: 999px;
            background: linear-gradient(90deg,
                    #EAF8EF 0%,
                    #B8E2D9 12%,
                    #BADAF0 24%,
                    #CDC8DE 36%,
                    #E3B3C0 48%,
                    #F4ABA8 58%,
                    #F7CDA4 70%,
                    #F3DBAD 80%,
                    #E2C3C7 90%,
                    #F0E3EF 100%);
            filter: blur(6px);
            opacity: 0.95;
            z-index: -1;
        }

        /* ===== Main card - full fill for iframe ===== */
        .widget-card {
            background: #FFFFFF;
            border-radius: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Floating back button - using CSS gradient instead of images */
        .back-btn {
            width: 55px;
            height: 55px;
            border-radius: 999px;
            box-shadow: 0 10px 18px rgba(0, 0, 0, 0.12);
        }

        /* Hide scrollbars completely */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
            width: 0;
            height: 0;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Chat container - hide scrollbar but allow scrolling */
        #chatContainer {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        #chatContainer::-webkit-scrollbar {
            display: none;
        }

        /* Suggestion buttons styling */
        .suggestion-btn {
            text-align: right;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .suggestion-btn:hover {
            transform: translateX(-2px);
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .suggestion-link {
            text-decoration: none;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .suggestion-link:hover {
            transform: translateX(-2px);
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        /* ===== Markdown Styling ===== */
        .markdown-content {
            line-height: 1.8;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            color: #1f2937;
        }

        .markdown-content h1 {
            font-size: 1.875rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5em;
        }

        .markdown-content h2 {
            font-size: 1.5rem;
        }

        .markdown-content h3 {
            font-size: 1.25rem;
        }

        .markdown-content p {
            margin-bottom: 1em;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin-right: 1.5em;
            margin-bottom: 1em;
        }

        .markdown-content li {
            margin-bottom: 0.5em;
        }

        .markdown-content code {
            background-color: #f3f4f6;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.875em;
            font-family: 'Courier New', Courier, monospace;
        }

        .markdown-content pre {
            background-color: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 1em;
        }

        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
            color: inherit;
        }

        .markdown-content blockquote {
            border-right: 4px solid #3b82f6;
            padding-right: 1rem;
            margin-right: 0;
            margin-bottom: 1em;
            color: #4b5563;
            font-style: italic;
        }

        .markdown-content a {
            color: #3b82f6;
            text-decoration: underline;
        }

        .markdown-content a:hover {
            color: #2563eb;
        }

        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
        }

        .markdown-content th,
        .markdown-content td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: right;
        }

        .markdown-content th {
            background-color: #f3f4f6;
            font-weight: 600;
        }

        .markdown-content hr {
            border: none;
            border-top: 1px solid #e5e7eb;
            margin: 2em 0;
        }

        /* Auto-resize textarea */
        textarea {
            resize: none;
            overflow-y: hidden;
        }
    </style>
</head>

<body class="bg-white">
    <div class="w-full h-full">
        <div class="widget-card h-full">
            <!-- Header -->
            <div class="flex items-center justify-between px-4 sm:px-5 md:px-6 py-3 sm:py-4 md:py-5 bg-white border-b border-gray-200">
                <div class="flex items-center gap-2 sm:gap-3">
                    <button id="newSessionBtn"
                        class="back-btn flex items-center justify-center bg-gradient-to-br from-blue-50 to-purple-50 hover:from-blue-100 hover:to-purple-100 transition-all duration-200">
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-gray-700" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 4v16m8-8H4" />
                        </svg>
                    </button>
                    <div>
                        <h1 class="text-base sm:text-lg md:text-xl font-bold text-gray-800">هوش مصنوعی سفیران آیه ها</h1>
                        <p class="text-[11px] sm:text-xs text-gray-500">دستیار هوشمند شما</p>
                    </div>
                </div>
            </div>

            <!-- Chat messages -->
            <div id="chatContainer" class="flex-1 overflow-y-auto px-3 sm:px-4 md:px-6 py-4 sm:py-6 space-y-4"></div>

            <!-- Input area -->
            <div class="bg-white border-t border-gray-200 px-3 sm:px-4 md:px-6 py-3 sm:py-4">
                <div class="flex items-end gap-2 sm:gap-3">
                    <textarea id="messageInput" rows="1"
                        class="flex-1 px-3 sm:px-4 py-2 sm:py-2.5 border border-gray-300 rounded-xl sm:rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-[13px] sm:text-sm resize-none"
                        placeholder="پیام خود را بنویسید..." style="max-height: 120px;"></textarea>
                    <button id="sendButton"
                        class="w-10 h-10 sm:w-11 sm:h-11 rounded-full bg-gray-300 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center flex-shrink-0"
                        disabled>
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                d="M14 5l-7 7 7 7" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const newSessionBtn = document.getElementById('newSessionBtn');

        // Markdown parser: use marked if loaded, else simple fallback (handles CDN failures)
        function parseMarkdown(text) {
            if (typeof marked !== 'undefined') return marked.parse(text || '');
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        // Auto-resize textarea
        function autoResizeTextarea() {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
        }

        // Toggle send button state
        function updateSendButton() {
            const hasText = messageInput.value.trim().length > 0;
            sendButton.disabled = !hasText;
            
            // Remove all color classes first
            sendButton.classList.remove('bg-gray-300', 'bg-green-500', 'hover:bg-green-600');
            
            if (hasText) {
                sendButton.classList.add('bg-green-500', 'hover:bg-green-600');
            } else {
                sendButton.classList.add('bg-gray-300');
            }
        }

        messageInput.addEventListener('input', () => {
            autoResizeTextarea();
            updateSendButton();
        });

        // AI Client
        class AIClient {
            constructor(baseUrl) {
                this.baseUrl = baseUrl;
                this.sessionId = null;
                this.userData = null;
            }

            setSessionId(sessionId) {
                this.sessionId = sessionId;
            }

            setUserData(userData) {
                this.userData = userData;
            }

            newSession() {
                this.sessionId = null;
            }

            async sendMessage(message, streaming = true, fromSuggestion = false) {
                const endpoint = streaming ? `${this.baseUrl}/stream` : this.baseUrl;
                const payload = {
                    message: message,
                    session_id: this.sessionId || undefined,
                    user_data: this.userData || undefined,
                    from_suggestion: fromSuggestion
                };

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                if (streaming) {
                    return new StreamingResponse(response);
                }

                return await response.json();
            }
        }

        class StreamingResponse {
            constructor(response) {
                this.response = response;
                this.reader = response.body.getReader();
                this.decoder = new TextDecoder();
                this.buffer = '';
                this.sessionId = null;
            }

            async *chunks() {
                try {
                    while (true) {
                        const { done, value } = await this.reader.read();
                        if (done) break;

                        this.buffer += this.decoder.decode(value, { stream: true });
                        const lines = this.buffer.split('\n');
                        this.buffer = lines.pop() || '';

                        for (const line of lines) {
                            const trimmed = line.trim();
                            if (!trimmed || !trimmed.startsWith('data: ')) continue;

                            const data = trimmed.slice(6);
                            if (data === '[DONE]') return;

                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.session_id && !this.sessionId) {
                                    this.sessionId = parsed.session_id;
                                }
                                if (parsed.chunk) {
                                    yield parsed.chunk;
                                }
                            } catch (e) {
                                console.error('JSON parse error:', e);
                            }
                        }
                    }
                } finally {
                    this.reader.releaseLock();
                }
            }

            async getFullResponse() {
                return {
                    session_id: this.sessionId,
                    output: ''
                };
            }
        }

        const aiClient = new AIClient('https://hr-dify.liara.run/v1/chat-messages');

        // Typing messages
        const typingMessages = [
            'در حال پردازش...',
            'در حال تجزیه و تحلیل...',
            'در حال آماده‌سازی پاسخ...',
            'کمی صبر کنید...',
            'در حال جستجو...',
            'در حال بررسی...'
        ];

        let typingInterval;
        let currentTypingIndex = 0;

        function showTyping() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'flex items-center gap-2 mb-4 message-enter';
            typingDiv.innerHTML = `
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                    <span class="typing-text text-[13px] sm:text-[12px] text-gray-600 mr-2">${typingMessages[0]}</span>
                </div>
            `;
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            const typingText = typingDiv.querySelector('.typing-text');
            currentTypingIndex = 0;

            typingInterval = setInterval(() => {
                typingText.classList.add('fade');
                setTimeout(() => {
                    currentTypingIndex = (currentTypingIndex + 1) % typingMessages.length;
                    typingText.textContent = typingMessages[currentTypingIndex];
                    typingText.classList.remove('fade');
                }, 300);
            }, 3000);
        }

        function hideTyping() {
            if (typingInterval) {
                clearInterval(typingInterval);
                typingInterval = null;
            }
            const typingDiv = document.getElementById('typingIndicator');
            if (typingDiv) {
                typingDiv.remove();
            }
        }

        function renderWelcome() {
            chatContainer.innerHTML = '';
        }

        newSessionBtn.addEventListener('click', () => {
            aiClient.newSession();
            renderWelcome();
            messageInput.value = '';
            messageInput.style.height = 'auto';
            updateSendButton();
        });

        async function sendMessage(fromSuggestion = false) {
            const message = messageInput.value.trim();
            if (!message) return;

            const userMessage = document.createElement('div');
            userMessage.className = 'flex justify-start mb-4 message-enter';
            userMessage.innerHTML = `
                <div class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-4 sm:px-5 py-2 sm:py-3 rounded-2xl max-w-[85%] sm:max-w-[75%]">
                    <p class="text-[13px] sm:text-sm break-words">${escapeHtml(message)}</p>
                </div>
            `;
            chatContainer.appendChild(userMessage);
            messageInput.value = '';
            messageInput.style.height = 'auto';
            updateSendButton();
            chatContainer.scrollTop = chatContainer.scrollHeight;

            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-end mb-4 message-enter';
            messageDiv.style.display = 'none';
            const streamingContent = document.createElement('div');
            streamingContent.className = 'markdown-content bg-white px-4 sm:px-5 py-3 sm:py-4 rounded-2xl shadow-sm max-w-[85%] sm:max-w-[75%] text-[13px] sm:text-sm';
            messageDiv.appendChild(streamingContent);
            chatContainer.appendChild(messageDiv);

            showTyping();
            sendButton.disabled = true;

            try {
                const streamResponse = await aiClient.sendMessage(message, true, fromSuggestion);
                let fullText = '';
                let hasReceivedData = false;

                try {
                    for await (const chunk of streamResponse.chunks()) {
                        if (!hasReceivedData) {
                            hasReceivedData = true;
                            hideTyping();
                            messageDiv.style.display = 'block';
                        }
                        
                        if (streamResponse.sessionId && !aiClient.sessionId) {
                            aiClient.setSessionId(streamResponse.sessionId);
                        }
                        
                        fullText += chunk;
                        streamingContent.innerHTML = parseMarkdown(fullText);
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }
                    
                    if (!hasReceivedData && fullText.length === 0) {
                        hideTyping();
                        messageDiv.style.display = 'block';
                        streamingContent.innerHTML = '<p class="text-red-500">خطا: هیچ پاسخی از سرور دریافت نشد. لطفا دوباره تلاش کنید.</p>';
                    }
                } catch (streamError) {
                    console.error('Error while reading stream:', streamError);
                    hideTyping();
                    messageDiv.style.display = 'block';
                    streamingContent.innerHTML = `<p class="text-red-500">خطا در دریافت پاسخ: ${escapeHtml(streamError.message)}</p>`;
                    throw streamError;
                }
                
                hideTyping();

                const finalResponse = await streamResponse.getFullResponse();
                
                if (finalResponse.session_id) {
                    aiClient.setSessionId(finalResponse.session_id);
                }
                
                // Parse suggestions if present (each item may be "label" or "label | url")
                const suggestionsMatch = fullText.match(/پیشنهادهای بعدی:\s*([\s\S]*?)(?:\n\n|$)/);
                if (suggestionsMatch) {
                    const mainText = fullText.substring(0, suggestionsMatch.index).trim();
                    const suggestionsText = suggestionsMatch[1].trim();
                    const rawItems = suggestionsText.split(/\n\s*(?=\d+\))/).filter(s => s.trim()).map(s => {
                        return s.replace(/^\d+\)\s*/, '').trim();
                    });
                    const suggestions = rawItems.map(s => {
                        const pipe = s.indexOf(' | ');
                        if (pipe > 0) {
                            const label = s.substring(0, pipe).trim();
                            const url = s.substring(pipe + 3).trim();
                            return { label, url: url.startsWith('http') ? url : null };
                        }
                        return { label: s, url: null };
                    });

                    if (suggestions.length > 0) {
                        const suggestionsHtml = `
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <p class="text-[13px] sm:text-[12px] font-semibold text-gray-600 mb-2">پیشنهادهای بعدی:</p>
                                <div class="space-y-2">
                                    ${suggestions.map((item, idx) => {
                                        if (item.url) {
                                            return `<a href="${escapeHtml(item.url)}" target="_blank" rel="noopener noreferrer" class="suggestion-link block w-full text-right text-[13px] sm:text-[12px] text-blue-600 hover:text-blue-700 hover:bg-blue-50 px-3 py-2.5 sm:py-2 rounded-lg transition-colors cursor-pointer">${idx + 1}) ${escapeHtml(item.label)}</a>`;
                                        }
                                        return `<button class="suggestion-btn w-full text-right text-[13px] sm:text-[12px] text-blue-600 hover:text-blue-700 hover:bg-blue-50 px-3 py-2.5 sm:py-2 rounded-lg transition-colors cursor-pointer" data-suggestion="${escapeHtml(item.label)}">${idx + 1}) ${escapeHtml(item.label)}</button>`;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                        streamingContent.innerHTML = parseMarkdown(mainText) + suggestionsHtml;
                        
                        messageDiv.querySelectorAll('.suggestion-btn').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const suggestion = btn.getAttribute('data-suggestion');
                                messageInput.value = suggestion;
                                messageInput.focus();
                                autoResizeTextarea();
                                sendMessage(true);
                            });
                        });
                    }
                }

            } catch (error) {
                console.error('Streaming error:', error);
                hideTyping();
                messageDiv.style.display = 'block';
                
                try {
                    const response = await aiClient.sendMessage(message, false, fromSuggestion);
                    const fullText = response.output || '';
                    const suggestionsMatch = fullText.match(/پیشنهادهای بعدی:\s*([\s\S]*?)(?:\n\n|$)/);
                    if (suggestionsMatch) {
                        const mainText = fullText.substring(0, suggestionsMatch.index).trim();
                        const suggestionsText = suggestionsMatch[1].trim();
                        const rawItems = suggestionsText.split(/\n\s*(?=\d+\))/).filter(s => s.trim()).map(s => s.replace(/^\d+\)\s*/, '').trim());
                        const suggestions = rawItems.map(s => {
                            const pipe = s.indexOf(' | ');
                            if (pipe > 0) {
                                const label = s.substring(0, pipe).trim();
                                const url = s.substring(pipe + 3).trim();
                                return { label, url: url.startsWith('http') ? url : null };
                            }
                            return { label: s, url: null };
                        });
                        if (suggestions.length > 0) {
                            const suggestionsHtml = `<div class="mt-4 pt-4 border-t border-gray-200"><p class="text-[13px] sm:text-[12px] font-semibold text-gray-600 mb-2">پیشنهادهای بعدی:</p><div class="space-y-2">${suggestions.map((item, idx) => item.url ? `<a href="${escapeHtml(item.url)}" target="_blank" rel="noopener noreferrer" class="suggestion-link block w-full text-right text-[13px] sm:text-[12px] text-blue-600 hover:text-blue-700 hover:bg-blue-50 px-3 py-2.5 sm:py-2 rounded-lg">${idx + 1}) ${escapeHtml(item.label)}</a>` : `<button class="suggestion-btn w-full text-right text-[13px] sm:text-[12px] text-blue-600 hover:text-blue-700 hover:bg-blue-50 px-3 py-2.5 sm:py-2 rounded-lg" data-suggestion="${escapeHtml(item.label)}">${idx + 1}) ${escapeHtml(item.label)}</button>`).join('')}</div></div>`;
                            streamingContent.innerHTML = parseMarkdown(mainText) + suggestionsHtml;
                            messageDiv.querySelectorAll('.suggestion-btn').forEach(btn => {
                                btn.addEventListener('click', () => {
                                    messageInput.value = btn.getAttribute('data-suggestion');
                                    messageInput.focus();
                                    autoResizeTextarea();
                                    sendMessage(true);
                                });
                            });
                        } else {
                            streamingContent.innerHTML = parseMarkdown(fullText);
                        }
                    } else {
                        streamingContent.innerHTML = parseMarkdown(fullText);
                    }
                    if (response.session_id) {
                        aiClient.setSessionId(response.session_id);
                    }
                } catch (fallbackError) {
                    streamingContent.innerHTML = 'خطا در ارتباط با سرور. لطفا دوباره تلاش کنید.';
                }
            } finally {
                sendButton.disabled = false;
            }
        }

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initial render
        renderWelcome();
        messageInput.focus();
    </script>
</body>

</html>
