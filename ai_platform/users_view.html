<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen font-sans antialiased">
    <div class="flex flex-col h-screen overflow-hidden">
        <header class="flex items-center justify-between px-6 py-4 bg-gray-900 border-b border-gray-700 flex-shrink-0">
            <h1 class="text-xl font-semibold tracking-tight">User Management</h1>
            <div class="flex gap-3">
                <a href="/monitoring/dashboard" class="text-sm text-blue-400 hover:text-blue-300">Trace Dashboard</a>
                <a href="/monitoring/logs/view" class="text-sm text-blue-400 hover:text-blue-300">Logs</a>
            </div>
        </header>

        <!-- List view -->
        <div id="list-view" class="flex-1 flex flex-col overflow-hidden">
            <div class="px-6 py-3 bg-gray-900/50 border-b border-gray-800 flex items-center justify-between flex-wrap gap-2 flex-shrink-0">
                <span id="list-stats" class="text-sm text-gray-400">Loading users…</span>
                <div class="flex items-center gap-3 text-sm">
                    <label class="text-gray-400">Page size</label>
                    <select id="page-size" class="px-2 py-1.5 bg-gray-800 border border-gray-700 rounded text-gray-200 focus:ring-1 focus:ring-blue-500">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
            <div class="flex-1 overflow-auto px-6 py-4">
                <table class="w-full text-sm border-collapse">
                    <thead class="sticky top-0 bg-gray-900 z-10">
                        <tr class="text-left text-gray-400 border-b border-gray-700">
                            <th class="pb-2 pr-4 font-medium">User ID</th>
                            <th class="pb-2 pr-4 font-medium">Sessions</th>
                            <th class="pb-2 pr-4 font-medium">Last activity</th>
                            <th class="pb-2 font-medium w-24"></th>
                        </tr>
                    </thead>
                    <tbody id="user-rows">
                        <tr><td colspan="4" class="py-8 text-center text-gray-500">Loading…</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="flex items-center justify-between px-6 py-3 bg-gray-900 border-t border-gray-800 flex-shrink-0">
                <div class="text-sm text-gray-400">
                    Page <span id="page-num">1</span> of <span id="page-total">1</span>
                    (<span id="total-count">0</span> total users)
                </div>
                <div class="flex gap-2">
                    <button type="button" id="btn-prev" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed rounded text-sm text-gray-200">Prev</button>
                    <button type="button" id="btn-next" class="px-3 py-1.5 bg-gray-700 hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed rounded text-sm text-gray-200">Next</button>
                </div>
            </div>
        </div>

        <!-- Detail view (hidden by default) -->
        <div id="detail-view" class="hidden flex-1 flex flex-col overflow-hidden">
            <div class="px-6 py-3 bg-gray-900 border-b border-gray-700 flex items-center gap-4 flex-shrink-0">
                <button type="button" id="btn-back" class="text-sm text-blue-400 hover:text-blue-300">← Back to list</button>
                <h2 id="detail-title" class="text-lg font-medium">User <span id="detail-user-id"></span></h2>
            </div>
            <div class="flex-1 overflow-auto px-6 py-4 space-y-6">
                <!-- Safiran User Data (GetAIUserData) -->
                <section class="rounded-lg border border-gray-700 overflow-hidden">
                    <div class="px-4 py-2 bg-gray-800 text-gray-200 font-semibold">Safiran User Data (GetAIUserData)</div>
                    <div id="safiran-data" class="p-4 font-mono text-sm text-gray-300 whitespace-pre-wrap break-words"></div>
                    <div id="safiran-error" class="hidden p-4 text-amber-400 text-sm"></div>
                </section>
                <!-- Sessions -->
                <section class="rounded-lg border border-gray-700 overflow-hidden">
                    <div class="px-4 py-2 bg-gray-800 text-gray-200 font-semibold">Sessions</div>
                    <p class="px-4 py-1 text-xs text-gray-500">Chat history is stored in the DB and appears here when the user sends messages with the same session ID from the chat UI.</p>
                    <div id="sessions-list" class="divide-y divide-gray-800"></div>
                    <div id="sessions-error" class="hidden p-4 text-amber-400 text-sm"></div>
                </section>
            </div>
        </div>
    </div>

    <script>
        (function () {
            const listView = document.getElementById('list-view');
            const detailView = document.getElementById('detail-view');
            const listStats = document.getElementById('list-stats');
            const userRows = document.getElementById('user-rows');
            const btnBack = document.getElementById('btn-back');
            const detailUserId = document.getElementById('detail-user-id');
            const safiranData = document.getElementById('safiran-data');
            const safiranError = document.getElementById('safiran-error');
            const sessionsList = document.getElementById('sessions-list');
            const sessionsError = document.getElementById('sessions-error');

            let currentPage = 1;
            let pageSize = 25;
            let totalUsers = 0;

            async function fetchUsers(page, limit) {
                const params = new URLSearchParams({ page: String(page || 1), limit: String(limit || pageSize) });
                const res = await fetch('/monitoring/users?' + params.toString());
                if (!res.ok) throw new Error(res.statusText);
                return res.json();
            }

            async function fetchUserDetail(userId) {
                const res = await fetch('/monitoring/users/' + encodeURIComponent(userId));
                if (!res.ok) throw new Error(res.statusText);
                return res.json();
            }

            function showList() {
                listView.classList.remove('hidden');
                listView.classList.add('flex');
                detailView.classList.add('hidden');
            }

            function showDetail(userId) {
                listView.classList.add('hidden');
                detailView.classList.remove('hidden');
                detailUserId.textContent = userId;
                loadUserDetail(userId);
            }

            function renderUserRow(u) {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-800 hover:bg-gray-800/50 cursor-pointer';
                const lastActivity = u.last_activity ? new Date(u.last_activity).toLocaleString() : '—';
                tr.innerHTML = `
                    <td class="py-2 pr-4 font-mono text-gray-200">${escapeHtml(u.user_id)}</td>
                    <td class="py-2 pr-4 text-gray-400">${u.session_count}</td>
                    <td class="py-2 pr-4 text-gray-400">${lastActivity}</td>
                    <td class="py-2"><span class="text-blue-400 text-xs">View →</span></td>
                `;
                tr.addEventListener('click', () => showDetail(u.user_id));
                return tr;
            }

            function escapeHtml(s) {
                if (s == null) return '';
                const div = document.createElement('div');
                div.textContent = s;
                return div.innerHTML;
            }

            function fmtJson(o) {
                if (o == null) return '(none)';
                return typeof o === 'object' ? JSON.stringify(o, null, 2) : String(o);
            }

            async function loadUserDetail(userId) {
                safiranData.textContent = 'Loading…';
                safiranData.classList.remove('hidden');
                safiranError.classList.add('hidden');
                sessionsList.innerHTML = '<div class="p-4 text-gray-500">Loading…</div>';
                sessionsError.classList.add('hidden');

                try {
                    const data = await fetchUserDetail(userId);

                    if (data.safiran_user_data) {
                        safiranData.textContent = fmtJson(data.safiran_user_data);
                        safiranData.classList.remove('hidden');
                    } else if (data.safiran_user_data_error) {
                        safiranError.textContent = 'Error: ' + data.safiran_user_data_error;
                        safiranError.classList.remove('hidden');
                        safiranData.classList.add('hidden');
                    } else {
                        safiranData.textContent = '(No data or user not found)';
                    }

                    if (data.sessions_error) {
                        sessionsError.textContent = data.sessions_error;
                        sessionsError.classList.remove('hidden');
                        sessionsList.innerHTML = '';
                    } else if (data.sessions && data.sessions.length) {
                        sessionsList.innerHTML = '';
                        data.sessions.forEach((s, idx) => {
                            const card = document.createElement('div');
                            card.className = 'session-card border-b border-gray-800 last:border-0';
                            const shortId = s.session_id.slice(0, 8) + '…';
                            card.innerHTML = `
                                <div class="session-header flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-gray-800/50" data-session-idx="${idx}">
                                    <div class="flex items-center gap-4">
                                        <span class="expand-icon text-gray-500 text-xs">▼</span>
                                        <span class="font-mono text-gray-300">${shortId}</span>
                                        <span class="text-gray-500 text-xs">${s.agent_type || '—'}</span>
                                        <span class="text-gray-500 text-xs">${s.message_count || 0} messages</span>
                                        <span class="text-gray-500 text-xs">${s.updated_at ? new Date(s.updated_at).toLocaleString() : ''}</span>
                                    </div>
                                </div>
                                <div class="session-body hidden px-4 pb-4">
                                    <div class="grid grid-cols-1 gap-4">
                                        <div>
                                            <div class="text-xs text-gray-400 font-semibold mb-1">Chat history</div>
                                            <pre class="p-3 bg-gray-900 rounded text-xs text-gray-300 whitespace-pre-wrap break-words max-h-64 overflow-y-auto messages-block"></pre>
                                        </div>
                                        <div>
                                            <div class="text-xs text-gray-400 font-semibold mb-1">Context</div>
                                            <pre class="p-3 bg-gray-900 rounded text-xs text-gray-300 whitespace-pre-wrap break-words max-h-48 overflow-y-auto context-block"></pre>
                                        </div>
                                    </div>
                                </div>
                            `;
                            const header = card.querySelector('.session-header');
                            const body = card.querySelector('.session-body');
                            const icon = card.querySelector('.expand-icon');
                            const messagesBlock = card.querySelector('.messages-block');
                            const contextBlock = card.querySelector('.context-block');
                            const msgCount = (s.messages && s.messages.length) || 0;
                            messagesBlock.textContent = msgCount
                                ? fmtJson(s.messages)
                                : '(No messages yet. Chat history is saved when the user sends messages using this session ID from the chat UI.)';
                            contextBlock.textContent = fmtJson(s.context);
                            header.addEventListener('click', () => {
                                const isOpen = !body.classList.contains('hidden');
                                body.classList.toggle('hidden', isOpen);
                                icon.textContent = isOpen ? '▼' : '▲';
                            });
                            sessionsList.appendChild(card);
                        });
                    } else {
                        sessionsList.innerHTML = '<div class="p-4 text-gray-500">No sessions for this user.</div>';
                    }
                } catch (e) {
                    safiranError.textContent = 'Failed to load: ' + e.message;
                    safiranError.classList.remove('hidden');
                    sessionsList.innerHTML = '';
                }
            }

            function updatePagination(data) {
                const total = data.total || 0;
                const page = data.page || 1;
                const limit = data.limit || pageSize;
                const totalPages = Math.max(1, Math.ceil(total / limit));
                totalUsers = total;
                document.getElementById('page-num').textContent = page;
                document.getElementById('page-total').textContent = totalPages;
                document.getElementById('total-count').textContent = total;
                document.getElementById('btn-prev').disabled = page <= 1;
                document.getElementById('btn-next').disabled = page >= totalPages;
            }

            async function loadList(page) {
                const p = page !== undefined ? page : currentPage;
                currentPage = p;
                listStats.textContent = 'Loading…';
                userRows.innerHTML = '<tr><td colspan="4" class="py-8 text-center text-gray-500">Loading…</td></tr>';
                try {
                    const data = await fetchUsers(p, pageSize);
                    const users = data.users || [];
                    updatePagination(data);
                    listStats.textContent = users.length ? `Showing ${users.length} of ${data.total} user(s)` : (data.total ? 'No users on this page.' : 'No users.');
                    userRows.innerHTML = '';
                    if (users.length === 0) {
                        userRows.innerHTML = '<tr><td colspan="4" class="py-8 text-center text-gray-500">' +
                            (data.total ? 'No users on this page.' : 'No users with Safiranayeha user ID found. Users appear after chat/init with encrypted_param or user_id.') + '</td></tr>';
                    } else {
                        users.forEach(u => userRows.appendChild(renderUserRow(u)));
                    }
                } catch (e) {
                    listStats.textContent = 'Error: ' + e.message;
                    userRows.innerHTML = '<tr><td colspan="4" class="py-8 text-center text-amber-400">Failed to load users.</td></tr>';
                }
            }

            btnBack.addEventListener('click', () => { showList(); loadList(); });
            document.getElementById('page-size').addEventListener('change', function () {
                pageSize = parseInt(this.value, 10);
                currentPage = 1;
                loadList(1);
            });
            document.getElementById('btn-prev').addEventListener('click', () => { if (currentPage > 1) loadList(currentPage - 1); });
            document.getElementById('btn-next').addEventListener('click', () => {
                const totalPages = Math.max(1, Math.ceil(totalUsers / pageSize));
                if (currentPage < totalPages) loadList(currentPage + 1);
            });
            loadList(1);
        })();
    </script>
</body>
</html>
