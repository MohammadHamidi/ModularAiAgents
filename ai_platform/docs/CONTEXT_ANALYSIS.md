# ุชุญูู: ุนุฏู ุขฺฏุงู ุงุฌูุช ุงุฒ ูุจุฏุง ูุฑูุฏ ฺฉุงุฑุจุฑ (Path/Context)

## ุฎูุงุตู ูุดฺฉู

ุงุฌูุชโูุง **ููโุฏุงููุฏ ฺฉุงุฑุจุฑ ุงุฒ ฺฉุฏุงู ุตูุญู ุณุงุช** ฺุช ุฑุง ุจุงุฒ ฺฉุฑุฏู ุงุณุช. ููุช ฺฉุงุฑุจุฑ ูโฺฏูุฏ ยซููู ฺฉูุดยปุ ุงุฌูุช ููโุฏุงูุฏ ฺฉุงุฑุจุฑ ุฑู ฺฉุฏุงู ุตูุญู ุงุณุช (ูุณุช ฺฉูุดโูุงุ ุตูุญู ฺฉ ฺฉูุด ุฎุงุตุ ูพุฑููุงูุ ู ุบุฑู).

---

## ุฌุฑุงู ูุนู (Current Flow)

### ฑ. ูุจโุณุงุช ุณูุฑุงู ุขูโูุง

```
iframe src="https://safrainai.pish.run/ui?encrypted_param=ENCRYPTED_VALUE"
```

- `encrypted_param` ุดุงูู: `{ "UserId": "...", "Path": "konesh/list/" }` (ุฑูุฒฺฏุฐุงุฑ ุดุฏู)
- Path ูุซุงูโูุง: `/`, `konesh/list/`, `action-list`, `my-profile/saved-actions`, `actions/report-form`

### ฒ. Chat.html โ ููุฏุงุฑุฏู ุงููู

- `encrypted_param` ุฑุง ุงุฒ URL ูโุฎูุงูุฏ
- `POST /chat/init` ุจุง `{ encrypted_param: "..." }` ูุฑุงุฎูุงู ูโฺฉูุฏ

### ณ. chat/init โ ูพุฑุฏุงุฒุด

| ูุฑุญูู | ุนููุงุช |
|-------|--------|
| 1 | ุฑูุฒฺฏุดุง โ `UserId`, `Path` |
| 2 | ุฏุฑุงูุช `user_data` ุงุฒ API ุณูุฑุงู |
| 3 | ุงูุชุฎุงุจ agent ุจุง `path_router.get_agent_for_path(path)` |
| 4 | ุฐุฎุฑู `normalized_user_data` ุฏุฑ context_manager |
| 5 | ุจุฑฺฏุฑุฏุงูุฏู `session_id`, `agent_key`, `user_data`, `welcome_message` |

โ๏ธ **ูุดฺฉู**: ููุฏุงุฑ `Path` ููุท ุจุฑุง ุงูุชุฎุงุจ agent ุงุณุชูุงุฏู ูโุดูุฏ ู **ูฺโุฌุง ุฐุฎุฑู ููโุดูุฏ**.

### ด. ฺุช โ ุงุฑุณุงู ูพุงู

- `shared_context` ุงุฒ `context_manager.get_context(sid)` ุจุงุฑฺฏุฐุงุฑ ูโุดูุฏ
- ุดุงูู: ุงุทูุงุนุงุช ฺฉุงุฑุจุฑ ูุฑูุงูโุดุฏู (ุชูููุ ูุงูุ ุงุณุชุงูุ ุงูุชุงุฒุ ู ุบุฑู)
- ุดุงูู **ูุณุช**: `Path` ุง ูุจุฏุง ูุฑูุฏ ฺฉุงุฑุจุฑ

### ต. Prompt Builder

- `user_info` = `shared_context`
- ููุท ููุฏูุง ฺฉู ุฏุฑ `user_data_fields` ุชุนุฑู ุดุฏูโุงูุฏ ุฑุง ููุงุด ูโุฏูุฏ
- ูฺ ููุฏ ุจุฑุง `entry_path` / `source_page` ูุฌูุฏ ูุฏุงุฑุฏ

---

## ูุชุฌู

ุงุฌูุช ุงูโูุง ุฑุง ูโุฏุงูุฏ:

- โ ููุน agent (ูุซูุงู action_expert)
- โ ุงุทูุงุนุงุช ฺฉุงุฑุจุฑ (ูุงูุ ุงุณุชุงูุ ุงูุชุงุฒ ู โฆ)
- โ ุชุงุฑุฎฺู ฺฏูุชฺฏู

ุงุฌูุช ุงูโูุง ุฑุง **ููโุฏุงูุฏ**:

- โ ุตูุญูโุง ฺฉู ฺฉุงุฑุจุฑ ฺุช ุฑุง ุงุฒ ุขูุฌุง ุจุงุฒ ฺฉุฑุฏู (ูุซูุงู `/action-list`, `konesh/list/`)
- โ ุงูฺฉู ฺฉุงุฑุจุฑ ุฏุฑ ุญุงู ุฏุฏู ูุณุช ฺฉูุดโูุงุ ุตูุญู ฺฉ ฺฉูุดุ ุง ูพุฑููุงู ุงุณุช

ุจูุงุจุฑุงู ููุช ฺฉุงุฑุจุฑ ูโฺฏูุฏ ยซููู ฺฉูุดยปุ ุงุฌูุช ููโุชูุงูุฏ ยซูููยป ุฑุง ุจู ฺฉ ุตูุญู ูุดุฎุต ุฑุจุท ุฏูุฏ.

---

## ุฑุงูโุญู ูพุดููุงุฏ

### ฑ. ุฐุฎุฑู Path ุฏุฑ chat/init

ุฏุฑ `main.py`ุ ุจุนุฏ ุงุฒ ุฑูุฒฺฏุดุงุ ููุฏุงุฑ Path ุฑุง ูู ุฏุฑ context ุฐุฎุฑู ฺฉูุฏ:

```python
# After normalizing user_data, add entry_path
normalized_user_data["entry_path"] = {"value": path}
await context_manager.merge_context(session_id, normalized_user_data, agent_type=agent_key)
```

### ฒ. ููุงุด Path ุฏุฑ ูพุฑุงููพุช

ุฏุฑ `prompt_builder.py`ุ ุจููฺฉ ุงุถุงูู ฺฉูุฏ ฺฉู ุงฺฏุฑ `entry_path` ุฏุฑ `user_info` ุจูุฏุ ุจู ูพุฑุงููพุช ุงุถุงูู ุดูุฏ:

```
๐ ฺฉุงุฑุจุฑ ฺุช ุฑุง ุงุฒ ุตูุญู {path} ุจุงุฒ ฺฉุฑุฏู (ูุซูุงู ูุณุช ฺฉูุดโูุงุ ูพุฑููุงูุ ูุฑู ฺฏุฒุงุฑุด)
```

### ณ. (ุงุฎุชุงุฑ) ูฺฏุงุดุช Path ุจู ุชูุถุญ ูุงุฑุณ

ุจุฑุง Pathโูุง ุฑุงุฌุ ุชูุถุญ ูุงุฑุณ ุฏุฑ `website_routes.yaml` ุง `path_agent_mapping.yaml` ุชุนุฑู ุดูุฏ ุชุง ุฏุฑ ูพุฑุงููพุช ุฎูุงูุง ุจุงุดุฏุ ูุซูุงู:

- `konesh/list` โ ยซูุณุช ฺฉูุดโูุง ูุฑุขูยป
- `action-list` โ ยซููุฑุณุช ุงูุฏุงูุงุชยป
- `my-profile/saved-actions` โ ยซฺฉูุดโูุง ุฐุฎุฑูโุดุฏูยป

---

## ููุดู ูุณุฑูุง ูุนู (ุงุฒ doc.html)

| ูุณุฑ | Agent | ุชูุถุญ |
|------|-------|-------|
| `/`, `*/konesh/` | action_expert | ุชููุฏ ูุญุชูุง |
| `*/profile/` | journey_register | ูพุฑููุงู ู ุซุจุชโูุงู |
| ุณุงุฑ | guest_faq | ูพุดโูุฑุถ |

---

## ูุงูโูุง ูุฑุชุจุท

- `services/chat-service/main.py` โ chat/initุ merge_context
- `shared/prompt_builder.py` โ ุณุงุฎุช ูพุฑุงููพุช ู context
- `services/chat-service/config/path_agent_mapping.yaml` โ ูฺฏุงุดุช path ุจู agent
- `services/chat-service/config/website_routes.yaml` โ ุขุฏุฑุณโูุง ู ุชูุถุญุงุช ุตูุญุงุช
