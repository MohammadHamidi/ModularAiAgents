<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <title>Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø³ÙÛŒØ±Ø§Ù† Ø¢ÛŒÙ‡ Ù‡Ø§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap');

        * {
            font-family: 'Vazirmatn', sans-serif;
        }

        /* Iframe-friendly full viewport */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* ===== Motion ===== */
        .message-enter {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced typing indicator with smooth animation */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .typing-indicator span:not(.typing-text) {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #6b7280;
            animation: bounce 1.4s infinite ease-in-out;
            display: inline-block;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* Smooth fade animation for typing text */
        .typing-text {
            transition: opacity 0.3s ease-in-out;
            white-space: nowrap;
        }

        .typing-text.fade {
            opacity: 0.5;
        }

        /* ===== Screenshot-matched welcome bubble glow ===== */
        .welcome-bubble {
            position: relative;
            border-radius: 18px;
            background: #ffffff;
            box-shadow: 0 10px 24px rgba(20, 20, 20, 0.10);
            overflow: visible;
            isolation: isolate;
        }

        .welcome-bubble::after {
            content: "";
            position: absolute;
            left: 14px;
            right: 14px;
            bottom: -12px;
            height: 14px;
            border-radius: 999px;
            background: linear-gradient(90deg,
                    #EAF8EF 0%,
                    #B8E2D9 12%,
                    #BADAF0 24%,
                    #CDC8DE 36%,
                    #E3B3C0 48%,
                    #F4ABA8 58%,
                    #F7CDA4 70%,
                    #F3DBAD 80%,
                    #E2C3C7 90%,
                    #F0E3EF 100%);
            filter: blur(6px);
            opacity: 0.95;
            z-index: -1;
        }

        /* Gradient behind helper text message */
        .helper-message-gradient {
            position: relative;
            overflow: visible;
        }

        .helper-message-gradient::after {
            content: "";
            position: absolute;
            left: 14px;
            right: 14px;
            bottom: -12px;
            height: 14px;
            border-radius: 999px;
            background: linear-gradient(90deg,
                    #EAF8EF 0%,
                    #B8E2D9 12%,
                    #BADAF0 24%,
                    #CDC8DE 36%,
                    #E3B3C0 48%,
                    #F4ABA8 58%,
                    #F7CDA4 70%,
                    #F3DBAD 80%,
                    #E2C3C7 90%,
                    #F0E3EF 100%);
            filter: blur(6px);
            opacity: 0.95;
            z-index: -1;
        }

        /* ===== Main card - full fill for iframe ===== */
        .widget-card {
            background: #FFFFFF;
            border-radius: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Floating back button - using CSS gradient instead of images */
        .back-btn {
            width: 55px;
            height: 55px;
            border-radius: 999px;
            box-shadow: 0 10px 18px rgba(0, 0, 0, 0.12);
        }

        /* Hide scrollbars completely */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
            width: 0;
            height: 0;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Chat container - hide scrollbar but allow scrolling */
        #chatContainer {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        #chatContainer::-webkit-scrollbar {
            display: none;
        }

        /* Suggestion buttons styling */
        .suggestion-btn {
            text-align: right;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .suggestion-btn:hover {
            transform: translateX(-2px);
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        /* ===== Markdown Styling ===== */
        .markdown-content {
            line-height: 1.8;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            color: #1f2937;
        }

        .markdown-content h1 {
            font-size: 1.875rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5em;
        }

        .markdown-content h2 {
            font-size: 1.5rem;
        }

        .markdown-content h3 {
            font-size: 1.25rem;
        }

        .markdown-content p {
            margin-bottom: 1em;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin-right: 1.5em;
            margin-bottom: 1em;
        }

        .markdown-content li {
            margin-bottom: 0.5em;
        }

        .markdown-content code {
            background-color: #f3f4f6;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.875em;
            font-family: 'Courier New', Courier, monospace;
        }

        .markdown-content pre {
            background-color: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 1em;
        }

        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
            color: inherit;
        }

        .markdown-content blockquote {
            border-right: 4px solid #3b82f6;
            padding-right: 1rem;
            margin-right: 0;
            margin-bottom: 1em;
            color: #4b5563;
            font-style: italic;
        }

        .markdown-content a {
            color: #3b82f6;
            text-decoration: underline;
        }

        .markdown-content a:hover {
            color: #2563eb;
        }

        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1em;
        }

        .markdown-content th,
        .markdown-content td {
            border: 1px solid #e5e7eb;
            padding: 0.5rem;
            text-align: right;
        }

        .markdown-content th {
            background-color: #f3f4f6;
            font-weight: 600;
        }

        .markdown-content hr {
            border: none;
            border-top: 1px solid #e5e7eb;
            margin: 2em 0;
        }

        /* Auto-resize textarea */
        textarea {
            resize: none;
            overflow-y: hidden;
        }

        /* Session sidebar */
        #sessionSidebar {
            transition: transform 0.25s ease, width 0.25s ease;
            z-index: 40;
        }
        #sessionSidebar.sidebar-hidden {
            transform: translateX(-100%);
            width: 0;
            min-width: 0;
            overflow: hidden;
        }
        /* Hide chat content when sidebar is open */
        #chatContainer,
        .chat-input-area {
            transition: opacity 0.2s ease;
        }
        body.sidebar-open #chatContainer,
        body.sidebar-open .chat-input-area {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>

<body class="bg-white">
    <div class="w-full h-full flex overflow-hidden">
        <!-- Session sidebar (collapsible) -->
        <aside id="sessionSidebar" class="sidebar-hidden flex-shrink-0 w-64 sm:w-72 min-w-0 bg-gray-50 border-l border-gray-200 flex flex-col h-full">
            <div class="p-3 border-b border-gray-200 flex items-center justify-between">
                <span class="text-sm font-medium text-gray-700">Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ÛŒ Ù…Ù†</span>
            </div>
            <div id="sessionList" class="flex-1 overflow-y-auto no-scrollbar p-2 space-y-1">
                <div id="sessionListItems" class="space-y-1"></div>
                <div id="sessionListEmpty" class="hidden text-center py-6 text-gray-500 text-sm">Ù‡ÛŒÚ† Ú¯ÙØªÚ¯ÙˆÛŒ Ù‚Ø¨Ù„ÛŒ Ù†ÛŒØ³Øª</div>
            </div>
        </aside>

        <!-- Main chat area -->
        <div class="flex-1 flex flex-col min-w-0 h-full">
        <div class="widget-card h-full flex flex-col">
            <!-- Header -->
            <div class="flex items-center justify-between px-4 sm:px-5 md:px-6 py-3 sm:py-4 md:py-5 bg-white border-b border-gray-200">
                <div class="flex items-center gap-2">
                    <button id="sidebarToggle" class="p-2 rounded-lg hover:bg-gray-100 transition-colors" title="Ú¯ÙØªÚ¯ÙˆÙ‡Ø§ÛŒ Ù…Ù†" aria-label="Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…Ù†ÙˆÛŒ Ú¯ÙØªÚ¯ÙˆÙ‡Ø§">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                    </button>
                </div>
                <div class="flex items-center gap-2 sm:gap-3 flex-1 justify-end">
                    <div class="back-btn flex items-center justify-center bg-gradient-to-br from-blue-50 to-purple-50">
                        <img src="/ui/icon.png" alt="Logo" class="w-10 h-10 sm:w-12 sm:h-12 object-contain" />
                    </div>
                    <div>
                        <h1 class="text-base sm:text-lg md:text-xl font-bold text-gray-800">Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø³ÙÛŒØ±Ø§Ù† Ø¢ÛŒÙ‡ Ù‡Ø§</h1>
                        <p id="headerSubtitle" class="text-[11px] sm:text-xs text-gray-500">Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø´Ù…Ø§</p>
                    </div>
                </div>
            </div>

            <!-- Chat messages -->
            <div id="chatContainer" class="flex-1 overflow-y-auto px-3 sm:px-4 md:px-6 py-4 sm:py-6 space-y-4"></div>

            <!-- Input area -->
            <div class="chat-input-area bg-white border-t border-gray-200 px-3 sm:px-4 md:px-6 py-3 sm:py-4">
                <div class="flex items-end gap-2 sm:gap-3">
                    <textarea id="messageInput" rows="1"
                        class="flex-1 px-3 sm:px-4 py-2 sm:py-2.5 border border-gray-300 rounded-xl sm:rounded-2xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-[13px] sm:text-sm resize-none"
                        placeholder="Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..." style="max-height: 120px;"></textarea>
                    <button id="sendButton"
                        class="w-10 h-10 sm:w-11 sm:h-11 rounded-full bg-gray-300 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center flex-shrink-0"
                        disabled>
                        <svg class="w-5 h-5 sm:w-6 sm:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                d="M14 5l-7 7 7 7" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        </div>
    </div>

    <!-- Feedback Modal (Farsi) -->
    <div id="feedbackModal" class="fixed inset-0 z-50 hidden" dir="rtl">
        <div class="absolute inset-0 bg-black/50" id="feedbackModalBackdrop"></div>
        <div class="absolute inset-0 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯</h3>
                <div class="space-y-3 mb-4">
                    <p class="text-sm text-gray-600">Ø¯Ù„Ø§ÛŒÙ„ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ):</p>
                    <div id="feedbackReasons" class="flex flex-wrap gap-2">
                        <button type="button" class="feedback-reason-chip px-3 py-1.5 rounded-full border border-gray-300 text-sm hover:bg-gray-50" data-code="incorrect">Ù†Ø§Ø¯Ø±Ø³Øª ÛŒØ§ Ù†Ø§Ù‚Øµ</button>
                        <button type="button" class="feedback-reason-chip px-3 py-1.5 rounded-full border border-gray-300 text-sm hover:bg-gray-50" data-code="not_requested">Ù…Ø·Ø§Ø¨Ù‚ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ø¨ÙˆØ¯</button>
                        <button type="button" class="feedback-reason-chip px-3 py-1.5 rounded-full border border-gray-300 text-sm hover:bg-gray-50" data-code="slow_or_buggy">Ú©Ù†Ø¯ ÛŒØ§ Ø¯Ø§Ø±Ø§ÛŒ Ø¨Ø§Ú¯</button>
                        <button type="button" class="feedback-reason-chip px-3 py-1.5 rounded-full border border-gray-300 text-sm hover:bg-gray-50" data-code="tone_or_style">Ù„Ø­Ù† ÛŒØ§ Ù†Ú¯Ø§Ø±Ø´ Ù†Ø§Ù…Ù†Ø§Ø³Ø¨</button>
                        <button type="button" class="feedback-reason-chip px-3 py-1.5 rounded-full border border-gray-300 text-sm hover:bg-gray-50" data-code="security_legal">Ù†Ú¯Ø±Ø§Ù†ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ ÛŒØ§ Ù‚Ø§Ù†ÙˆÙ†ÛŒ</button>
                        <button type="button" class="feedback-reason-chip px-3 py-1.5 rounded-full border border-gray-300 text-sm hover:bg-gray-50" data-code="other">Ø³Ø§ÛŒØ±</button>
                    </div>
                </div>
                <textarea id="feedbackComment" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm resize-none mb-4" rows="3" placeholder="Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)"></textarea>
                <div class="flex gap-2 justify-end">
                    <button type="button" id="feedbackCancel" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50">Ø§Ù†ØµØ±Ø§Ù</button>
                    <button type="button" id="feedbackSubmit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Ø§Ø±Ø³Ø§Ù„</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');

        // Feedback feature state
        let feedbackEnabled = true;
        const submittedMessageIds = new Set();

        async function fetchFeedbackConfig() {
            try {
                const res = await fetch(`${baseUrl}/config`);
                if (res.ok) {
                    const data = await res.json();
                    feedbackEnabled = !!data.feedback_enabled;
                }
            } catch (_) { feedbackEnabled = false; }
        }

        function getLastMessages() {
            const items = chatContainer.querySelectorAll('.message-enter');
            const out = [];
            for (let i = Math.max(0, items.length - 2); i < items.length; i++) {
                const item = items[i];
                const isUser = item.classList.contains('flex') && item.classList.contains('justify-start');
                const contentEl = item.querySelector('.markdown-content, .bg-gradient-to-r');
                const content = contentEl ? (contentEl.textContent || '').trim() : '';
                const msgId = item.dataset.messageId || null;
                if (content) out.push({ role: isUser ? 'user' : 'assistant', content, message_id: msgId });
            }
            return out;
        }

        function createMessageActions(messageId, content) {
            if (!feedbackEnabled || !messageId) return null;
            const wrapper = document.createElement('div');
            wrapper.className = 'flex items-center gap-1 mt-1';
            const likeBtn = document.createElement('button');
            likeBtn.type = 'button';
            likeBtn.className = 'p-1 rounded hover:bg-gray-100 text-gray-500 hover:text-green-600 transition';
            likeBtn.title = 'Ù¾Ø³Ù†Ø¯ÛŒØ¯Ù†';
            likeBtn.innerHTML = 'ğŸ‘';
            const dislikeBtn = document.createElement('button');
            dislikeBtn.type = 'button';
            dislikeBtn.className = 'p-1 rounded hover:bg-gray-100 text-gray-500 hover:text-red-600 transition';
            dislikeBtn.title = 'Ù†Ù¾Ø³Ù†Ø¯ÛŒØ¯Ù†';
            dislikeBtn.innerHTML = 'ğŸ‘';
            const copyBtn = document.createElement('button');
            copyBtn.type = 'button';
            copyBtn.className = 'p-1 rounded hover:bg-gray-100 text-gray-500 hover:text-blue-600 transition';
            copyBtn.title = 'Ú©Ù¾ÛŒ';
            copyBtn.innerHTML = 'ğŸ“‹';
            const setDisabled = (disabled) => {
                likeBtn.disabled = dislikeBtn.disabled = copyBtn.disabled = disabled;
            };
            likeBtn.addEventListener('click', async () => {
                if (submittedMessageIds.has(messageId)) return;
                setDisabled(true);
                try {
                    await submitLike(messageId);
                    submittedMessageIds.add(messageId);
                    likeBtn.classList.add('opacity-60');
                } finally { setDisabled(false); }
            });
            dislikeBtn.addEventListener('click', () => {
                if (submittedMessageIds.has(messageId)) return;
                openFeedbackModal(messageId, content);
            });
            copyBtn.addEventListener('click', () => copyToClipboard(content));
            wrapper.appendChild(likeBtn);
            wrapper.appendChild(dislikeBtn);
            wrapper.appendChild(copyBtn);
            return wrapper;
        }

        async function submitLike(messageId) {
            const payload = {
                session_id: aiClient.sessionId || null,
                user_id: aiClient.userData?.userId ?? null,
                message_id: messageId,
                feedback_type: 'like',
                reason_codes: null,
                comment: null,
                last_messages: getLastMessages(),
                timestamp: new Date().toISOString()
            };
            await fetch(`${baseUrl}/api/v1/chat/feedback`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        }

        async function submitDislike(messageId, reasonCodes, comment) {
            const payload = {
                session_id: aiClient.sessionId || null,
                user_id: aiClient.userData?.userId ?? null,
                message_id: messageId,
                feedback_type: 'dislike',
                reason_codes: reasonCodes && reasonCodes.length ? reasonCodes : null,
                comment: comment || null,
                last_messages: getLastMessages(),
                timestamp: new Date().toISOString()
            };
            const response = await fetch(`${baseUrl}/api/v1/chat/feedback`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`Failed to submit feedback: ${response.status}`);
            }
        }

        function copyToClipboard(text) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).catch(() => {
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }
        function fallbackCopy(text) {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.select();
            try { document.execCommand('copy'); } catch (_) {}
            document.body.removeChild(ta);
        }

        let feedbackModalMessageId = null;
        let feedbackModalContent = null;
        const feedbackReasons = new Set();

        function openFeedbackModal(messageId, content) {
            feedbackModalMessageId = messageId;
            feedbackModalContent = content;
            feedbackReasons.clear();
            document.getElementById('feedbackReasons').querySelectorAll('.feedback-reason-chip').forEach(el => {
                el.classList.remove('bg-blue-100', 'border-blue-500');
                el.classList.add('border-gray-300');
            });
            document.getElementById('feedbackComment').value = '';
            document.getElementById('feedbackModal').classList.remove('hidden');
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModal').classList.add('hidden');
            feedbackModalMessageId = null;
        }

        document.getElementById('feedbackModalBackdrop').addEventListener('click', closeFeedbackModal);
        document.getElementById('feedbackCancel').addEventListener('click', closeFeedbackModal);
        document.getElementById('feedbackReasons').addEventListener('click', (e) => {
            const chip = e.target.closest('.feedback-reason-chip');
            if (!chip) return;
            const code = chip.dataset.code;
            if (feedbackReasons.has(code)) {
                feedbackReasons.delete(code);
                chip.classList.remove('bg-blue-100', 'border-blue-500');
                chip.classList.add('border-gray-300');
            } else {
                feedbackReasons.add(code);
                chip.classList.add('bg-blue-100', 'border-blue-500');
                chip.classList.remove('border-gray-300');
            }
        });
        document.getElementById('feedbackSubmit').addEventListener('click', async () => {
            if (!feedbackModalMessageId || submittedMessageIds.has(feedbackModalMessageId)) return;
            const btn = document.getElementById('feedbackSubmit');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...';

            try {
                await submitDislike(feedbackModalMessageId, Array.from(feedbackReasons), document.getElementById('feedbackComment').value.trim() || null);
                submittedMessageIds.add(feedbackModalMessageId);
                closeFeedbackModal();
            } catch (error) {
                console.error('Failed to submit feedback:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§Ø²Ø®ÙˆØ±Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });

        // Markdown parser: use marked if loaded, else simple fallback (handles CDN failures)
        function parseMarkdown(text) {
            if (typeof marked !== 'undefined') return marked.parse(text || '');
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        // Auto-resize textarea
        function autoResizeTextarea() {
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';
        }

        // Toggle send button state
        function updateSendButton() {
            const hasText = messageInput.value.trim().length > 0;
            sendButton.disabled = !hasText;
            
            // Remove all color classes first
            sendButton.classList.remove('bg-gray-300', 'bg-green-500', 'hover:bg-green-600');
            
            if (hasText) {
                sendButton.classList.add('bg-green-500', 'hover:bg-green-600');
            } else {
                sendButton.classList.add('bg-gray-300');
            }
        }

        messageInput.addEventListener('input', () => {
            autoResizeTextarea();
            updateSendButton();
        });

        // AI Client
        class AIClient {
            constructor(baseUrl) {
                    this.baseUrl = baseUrl;
                this.sessionId = null;
                this.userData = null;
                this.agentKey = 'orchestrator'; // Default agent
            }

            setSessionId(sessionId) {
                this.sessionId = sessionId;
            }

            setUserData(userData) {
                this.userData = userData;
            }

            setAgentKey(agentKey) {
                this.agentKey = agentKey;
            }

            newSession() {
                this.sessionId = null;
            }

            async sendMessage(message, streaming = true) {
                const agentKey = this.agentKey || 'orchestrator';
                const endpoint = streaming 
                    ? `${this.baseUrl}/chat/${agentKey}/stream` 
                    : `${this.baseUrl}/chat/${agentKey}`;
                const payload = {
                        message: message,
                    session_id: this.sessionId || undefined,
                        use_shared_context: true,
                    user_data: this.userData || undefined
                };

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                if (streaming) {
                    return new StreamingResponse(response);
                }

                return await response.json();
            }
        }

        class StreamingResponse {
            constructor(response) {
                this.response = response;
                this.reader = response.body.getReader();
                this.decoder = new TextDecoder();
                this.buffer = '';
                this.sessionId = null;
                this.messageId = null;
            }

            async *chunks() {
                try {
                    while (true) {
                        const { done, value } = await this.reader.read();
                        if (done) break;

                        this.buffer += this.decoder.decode(value, { stream: true });
                        const lines = this.buffer.split('\n');
                        this.buffer = lines.pop() || '';

                        for (const line of lines) {
                            const trimmed = line.trim();
                            if (!trimmed || !trimmed.startsWith('data: ')) continue;

                            const data = trimmed.slice(6);
                            if (data === '[DONE]') return;

                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.session_id && !this.sessionId) {
                                    this.sessionId = parsed.session_id;
                                }
                                if (parsed.message_id) {
                                    this.messageId = parsed.message_id;
                                }
                                if (parsed.chunk) {
                                    yield parsed.chunk;
                                }
                                        } catch (e) {
                                console.error('JSON parse error:', e);
                                        }
                                    }
                                }
                        } finally {
                    this.reader.releaseLock();
                            }
                        }

            async getFullResponse() {
                return {
                    session_id: this.sessionId,
                    message_id: this.messageId,
                    output: ''
                };
            }
        }

        // Auto-detect base URL: if running on same domain, use relative path; otherwise use provided or default
        let baseUrl = null;
        const currentPath = window.location.pathname;
        if (currentPath.startsWith('/ui')) {
            // We're on /ui, so API is at root (gateway will forward)
            baseUrl = window.location.origin;
        } else {
            // Fallback for local development
            baseUrl = 'http://localhost:8000';
        }
        
        // Extract agent from URL for direct testing (e.g. /ui?agent=action_expert)
        function getAgentFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('agent') || null;
        }

        // Extract optional context from URL (e.g. /ui?agent=guest_faq&context=...)
        function getContextFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('context') || null;
        }

        // Extract encrypted parameter from URL (for Safiranayeha integration)
        function getEncryptedParamFromURL() {
            // Method 1: Query parameter (e.g., /ui?encrypted_param=...)
            const urlParams = new URLSearchParams(window.location.search);
            let encryptedParam = urlParams.get('encrypted_param') || urlParams.get('param');
            if (encryptedParam) return encryptedParam;
            
            // Method 2: Path parameter (e.g., /ui/{encrypted_param})
            const path = window.location.pathname;
            const pathParts = path.split('/').filter(p => p);
            
            // If we're on /ui, check if there's a parameter after it
            if (pathParts[0] === 'ui' && pathParts.length > 1) {
                return pathParts[1];
            }
            
            // If not on /ui, check if first path part is the encrypted param
            if (pathParts.length > 0 && pathParts[0] !== 'ui') {
                // Could be direct path like /{encrypted_param}
                return pathParts[0];
            }
            
            // Method 3: Hash parameter (e.g., /ui#encrypted_param)
            const hash = window.location.hash.substring(1);
            if (hash && hash.length > 20) { // Encrypted params are typically long
                return hash;
            }
            
            return null;
        }
        
        // Initialize with base URL (agent will be set dynamically)
        const aiClient = new AIClient(baseUrl);

        // Stored init params for "New chat" (Safiranayeha users)
        let safiranInitParams = { encryptedParam: null, fromPath: null };

        // Session sidebar state
        let sessionListCached = null;
        const sidebar = document.getElementById('sessionSidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sessionListItems = document.getElementById('sessionListItems');
        const sessionListEmpty = document.getElementById('sessionListEmpty');

        function closeSidebar() {
            if (sidebar) {
                sidebar.classList.add('sidebar-hidden');
                document.body.classList.remove('sidebar-open');
            }
        }
        function openSidebar() {
            if (sidebar) {
                sidebar.classList.remove('sidebar-hidden');
                document.body.classList.add('sidebar-open');
            }
        }
        function toggleSidebar() {
            if (sidebar) {
                sidebar.classList.toggle('sidebar-hidden');
                document.body.classList.toggle('sidebar-open');
            }
        }

        async function fetchUserSessions() {
            const sid = aiClient.sessionId;
            if (!sid) return { sessions: [] };
            try {
                const res = await fetch(`${baseUrl}/user/sessions?session_id=${encodeURIComponent(sid)}`);
                if (!res.ok) return { sessions: [] };
                return await res.json();
            } catch (e) {
                console.warn('Fetch user sessions failed:', e);
                return { sessions: [] };
            }
        }

        function formatRelativeTime(isoStr) {
            if (!isoStr) return '';
            const d = new Date(isoStr);
            const now = new Date();
            const diffMs = now - d;
            const diffM = Math.floor(diffMs / 60000);
            const diffH = Math.floor(diffMs / 3600000);
            const diffD = Math.floor(diffMs / 86400000);
            if (diffM < 1) return 'Ø§Ù„Ø§Ù†';
            if (diffM < 60) return diffM + ' Ø¯Ù‚ÛŒÙ‚Ù‡ Ù¾ÛŒØ´';
            if (diffH < 24) return diffH + ' Ø³Ø§Ø¹Øª Ù¾ÛŒØ´';
            if (diffD < 7) return diffD + ' Ø±ÙˆØ² Ù¾ÛŒØ´';
            return d.toLocaleDateString('fa-IR', { month: 'short', day: 'numeric', year: d.getFullYear() !== now.getFullYear() ? 'numeric' : undefined });
        }

        function renderSessionList(sessions) {
            if (!sessionListItems || !sessionListEmpty) return;
            sessionListItems.innerHTML = '';
            const list = sessions || [];
            if (list.length === 0) {
                sessionListEmpty.classList.remove('hidden');
                return;
            }
            sessionListEmpty.classList.add('hidden');
            list.forEach((s) => {
                const isActive = s.session_id === aiClient.sessionId;
                const btn = document.createElement('button');
                btn.className = 'session-item-btn w-full text-right px-3 py-2.5 rounded-lg text-[13px] transition-colors truncate ' + (isActive ? 'bg-blue-100 text-blue-800' : 'text-gray-700 hover:bg-gray-100');
                btn.title = s.title || 'Ú¯ÙØªÚ¯ÙˆÛŒ Ø¬Ø¯ÛŒØ¯';
                btn.dataset.sessionId = s.session_id;
                btn.dataset.agentType = s.agent_type || 'orchestrator';
                const titleEl = document.createElement('span');
                titleEl.className = 'block truncate';
                titleEl.textContent = s.title || 'Ú¯ÙØªÚ¯ÙˆÛŒ Ø¬Ø¯ÛŒØ¯';
                const timeEl = document.createElement('span');
                timeEl.className = 'block text-[11px] text-gray-500 mt-0.5';
                timeEl.textContent = formatRelativeTime(s.updated_at);
                btn.appendChild(titleEl);
                btn.appendChild(timeEl);
                btn.addEventListener('click', () => selectSession(s.session_id, s.agent_type));
                sessionListItems.appendChild(btn);
            });
        }

        async function selectSession(sessionId, agentType) {
            if (!sessionId) return;
            try {
                const res = await fetch(`${baseUrl}/session/${encodeURIComponent(sessionId)}/history`);
                if (!res.ok) throw new Error('Failed to load session');
                const data = await res.json();
                aiClient.setSessionId(sessionId);
                aiClient.setAgentKey(agentType || data.agent_type || 'orchestrator');
                renderMessagesFromHistory(data.messages || []);
                closeSidebar();
                renderSessionList(sessionListCached?.sessions || []);
            } catch (e) {
                console.error('Load session failed:', e);
            }
        }

        function renderMessagesFromHistory(messages) {
            chatContainer.innerHTML = '';
            if (!messages || messages.length === 0) return;
            const frag = document.createDocumentFragment();
            messages.forEach((m) => {
                const role = m.role || 'user';
                const content = (m.content || '').trim();
                const messageId = m.message_id || null;
                if (!content) return;
                const div = document.createElement('div');
                div.className = 'message-enter mb-4 ' + (role === 'user' ? 'flex justify-start' : 'flex justify-end');
                if (messageId) div.dataset.messageId = messageId;
                if (role === 'user') {
                    div.innerHTML = `<div class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-4 sm:px-5 py-2 sm:py-3 rounded-2xl max-w-[85%] sm:max-w-[75%]"><p class="text-[13px] sm:text-sm break-words">${escapeHtml(content)}</p></div>`;
                } else {
                    const inner = document.createElement('div');
                    inner.className = 'flex flex-col items-end';
                    const bubble = document.createElement('div');
                    bubble.className = 'markdown-content bg-white px-4 sm:px-5 py-3 sm:py-4 rounded-2xl shadow-sm max-w-[85%] sm:max-w-[75%] text-[13px] sm:text-sm';
                    bubble.innerHTML = parseMarkdown(content);
                    inner.appendChild(bubble);
                    const actions = createMessageActions(messageId, content);
                    if (actions) inner.appendChild(actions);
                    div.appendChild(inner);
                }
                frag.appendChild(div);
            });
            chatContainer.appendChild(frag);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        if (sidebarToggle) sidebarToggle.addEventListener('click', async () => {
            toggleSidebar();
            if (!sidebar.classList.contains('sidebar-hidden')) {
                if (aiClient.sessionId) {
                    sessionListCached = await fetchUserSessions();
                }
                renderSessionList(sessionListCached?.sessions || []);
            }
        });

        // Apply agent from URL if present (for direct testing without path mapping)
        const urlAgent = getAgentFromURL();
        if (urlAgent) {
            aiClient.setAgentKey(urlAgent);
            const subtitle = document.getElementById('headerSubtitle');
            if (subtitle) subtitle.textContent = 'ØªØ³Øª Ø§ÛŒØ¬Ù†Øª: ' + urlAgent;
            console.log('Using agent from URL:', urlAgent);
        }

        // Initialize chat from Safiranayeha encrypted parameter or from_path (e.g. /ai?from=/actions/21)
        async function initializeChatFromSafiranayeha() {
            // If agent was set via URL, skip Safiranayeha init (direct test mode)
            if (urlAgent) return false;

            const urlParams = new URLSearchParams(window.location.search);
            const fromParam = urlParams.get('from');
            const encryptedParam = getEncryptedParamFromURL();
            const fromPathDecoded = fromParam ? decodeURIComponent(fromParam) : null;

            // Call init when we have encrypted_param OR when we have from= (e.g. /ai?from=/actions/21)
            if (!encryptedParam && !fromPathDecoded) {
                console.debug('No Safiranayeha parameter or from= path found, using default agent');
                return false; // Indicates no initialization happened
            }

            try {
                safiranInitParams = { encryptedParam: encryptedParam || null, fromPath: fromPathDecoded };

                // Show loading state
                chatContainer.innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mb-4"></div>
                            <p class="text-gray-600 text-sm">Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…...</p>
                        </div>
                    </div>
                `;

                // Disable input during initialization
                messageInput.disabled = true;
                sendButton.disabled = true;

                // Build init body: from_path when present; encrypted_param when present
                const initBody = {};
                if (encryptedParam) initBody.encrypted_param = encryptedParam;
                if (fromPathDecoded) initBody.from_path = fromPathDecoded;
                if (!encryptedParam && fromPathDecoded) initBody.path = '/';

                const response = await fetch(`${baseUrl}/chat/init`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(initBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø·' }));
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // Store session info
                aiClient.setSessionId(data.session_id);
                aiClient.setUserData(data.user_data);
                aiClient.setAgentKey(data.agent_key);
                
                // Update subtitle if provided
                if (data.subtitle) {
                    const subtitle = document.getElementById('headerSubtitle');
                    if (subtitle) {
                        subtitle.textContent = data.subtitle;
                    }
                }
                
                // Clear loading and display welcome message with conversation starters
                chatContainer.innerHTML = '';
                
                if (data.welcome_message) {
                    const welcomeDiv = document.createElement('div');
                    welcomeDiv.className = 'flex justify-end mb-4 message-enter';
                    
                    // Build welcome message HTML
                    let welcomeHTML = `
                        <div class="welcome-bubble markdown-content px-4 sm:px-5 py-4 sm:py-5 rounded-2xl max-w-[90%] sm:max-w-[80%] text-[13px] sm:text-sm bg-white">
                            ${parseMarkdown(data.welcome_message)}
                    `;
                    
                    // Add conversation starters if provided
                    if (data.conversation_starters && data.conversation_starters.length > 0) {
                        welcomeHTML += `
                            <div class="helper-message-gradient mt-3 pt-3 border-t border-gray-100">
                                <p class="text-[11px] sm:text-[12px] text-gray-500 mb-2">
                                    Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÛŒÚ©ÛŒ Ø§Ø² Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ù‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:
                                </p>
                                <div class="space-y-2">
                        `;
                        
                        data.conversation_starters.forEach((starter, index) => {
                            welcomeHTML += `
                                <button class="suggestion-btn w-full text-right text-[12px] sm:text-[13px] text-blue-600 hover:text-blue-700 px-3 py-2 rounded-lg cursor-pointer transition-colors hover:bg-blue-50" data-suggestion="${escapeHtml(starter)}">
                                    ${index + 1}) ${escapeHtml(starter)}
                                </button>
                            `;
                        });
                        
                        welcomeHTML += `
                                </div>
                            </div>
                        `;
                    }
                    
                    welcomeHTML += `</div>`;
                    
                    welcomeDiv.innerHTML = welcomeHTML;
                    chatContainer.appendChild(welcomeDiv);
                    
                    // Attach click handlers to conversation starters
                    chatContainer.querySelectorAll('.suggestion-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const suggestion = btn.getAttribute('data-suggestion');
                            messageInput.value = suggestion;
                            autoResizeTextarea();
                            updateSendButton();
                            sendMessage();
                        });
                    });
                    
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
                
                // Enable input
                messageInput.disabled = false;
                sendButton.disabled = false;

                // Fetch session list for sidebar
                sessionListCached = await fetchUserSessions();
                renderSessionList(sessionListCached.sessions);
                // Auto-expand sidebar disabled - user must manually open it
                // if (sessionListCached.sessions && sessionListCached.sessions.length > 1) {
                //     openSidebar();
                // }
                
                console.log('Chat initialized successfully:', {
                    session_id: data.session_id,
                    agent_key: data.agent_key
                });
                
                return true; // Indicates successful initialization
                
            } catch (error) {
                console.error('Initialization error:', error);
                
                // Show error message but allow fallback to default
                chatContainer.innerHTML = `
                    <div class="flex justify-end mb-4">
                        <div class="bg-red-50 border border-red-200 text-red-700 px-4 sm:px-5 py-3 sm:py-4 rounded-2xl max-w-[85%] sm:max-w-[75%] text-[13px] sm:text-sm">
                            <p class="font-semibold mb-1">Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„</p>
                            <p>${escapeHtml(error.message)}</p>
                            <p class="mt-2 text-xs text-red-600">Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø­Ø§Ù„Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶...</p>
                        </div>
                    </div>
                `;
                
                // Enable input for fallback
                messageInput.disabled = false;
                sendButton.disabled = false;
                
                return false; // Indicates initialization failed
            }
        }

        // Typing messages
        const typingMessages = [
            'Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...',
            'Ø¯Ø± Ø­Ø§Ù„ ØªØ¬Ø²ÛŒÙ‡ Ùˆ ØªØ­Ù„ÛŒÙ„...',
            'Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø§Ø³Ø®...',
            'Ú©Ù…ÛŒ ØµØ¨Ø± Ú©Ù†ÛŒØ¯...',
            'Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...',
            'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...'
        ];

        let typingInterval;
        let currentTypingIndex = 0;

        function showTyping() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'flex items-center gap-2 mb-4 message-enter';
            typingDiv.innerHTML = `
          <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
                    <span class="typing-text text-[13px] sm:text-[12px] text-gray-600 mr-2">${typingMessages[0]}</span>
        </div>
      `;
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            const typingText = typingDiv.querySelector('.typing-text');
            currentTypingIndex = 0;

            typingInterval = setInterval(() => {
                typingText.classList.add('fade');
                    setTimeout(() => {
                    currentTypingIndex = (currentTypingIndex + 1) % typingMessages.length;
                    typingText.textContent = typingMessages[currentTypingIndex];
                    typingText.classList.remove('fade');
                }, 300);
            }, 3000);
        }

        function hideTyping() {
            if (typingInterval) {
                clearInterval(typingInterval);
                typingInterval = null;
            }
            const typingDiv = document.getElementById('typingIndicator');
            if (typingDiv) {
                typingDiv.remove();
            }
        }

        function renderWelcome() {
                chatContainer.innerHTML = `
        <div class="flex justify-end mb-4">
            <div class="welcome-bubble markdown-content px-4 sm:px-5 py-4 sm:py-5 rounded-2xl max-w-[90%] sm:max-w-[80%] text-[13px] sm:text-sm bg-white">
                <h2 class="text-sm sm:text-base font-semibold text-gray-800 mb-1">
                    Ø³Ù„Ø§Ù…ØŒ Ù…Ù† Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø³ÙÛŒØ±Ø§Ù† Ø¢ÛŒÙ‡â€ŒÙ‡Ø§ Ù‡Ø³ØªÙ… ğŸŒ¿
                </h2>
                <p class="text-[12px] sm:text-[13px] text-gray-600 mb-3">
                    Ø§ÛŒÙ†Ø¬Ø§ Ø§ØªØ§Ù‚ ÙØ±Ù…Ø§Ù† Ùˆ Ù¾Ø´Øªâ€ŒØµØ­Ù†Ù‡ Ù†Ù‡Ø¶Øª Â«Ø²Ù†Ø¯Ú¯ÛŒ Ø¨Ø§ Ø¢ÛŒÙ‡â€ŒÙ‡Ø§Â»Ø³Øª. Ù…Ù† Ø§ÛŒÙ†Ø¬Ø§Ù… ØªØ§ Ø¨Ù‡Øª Ú©Ù…Ú© Ú©Ù†Ù… Ù†Ù‚Ø´ Ø³ÙÛŒØ± Ø±Ùˆ Ø¨ÙÙ‡Ù…ÛŒØŒ Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ù†Ø§Ø³Ø¨ Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒ Ùˆ Ø¨Ø±Ø§Øª Ù…Ø­ØªÙˆØ§ ØªÙˆÙ„ÛŒØ¯ Ú©Ù†Ù….
                </p>
                <p class="text-[11px] sm:text-[12px] text-gray-500 mb-3">
                    Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÛŒÚ©ÛŒ Ø§Ø² Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ù‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø³ÙˆØ§Ù„ Ø®ÙˆØ¯ØªØ§Ù† Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯:
                </p>
                <div class="helper-message-gradient mt-2 pt-2 border-t border-gray-100">
                    <div class="space-y-2">
                        <button class="suggestion-btn w-full text-right text-[12px] sm:text-[13px] text-blue-600 hover:text-blue-700 px-3 py-2 rounded-lg cursor-pointer" data-suggestion="Ø³ÙÛŒØ± Ø¢ÛŒÙ‡â€ŒÙ‡Ø§ ÛŒØ¹Ù†ÛŒ Ú†ÛŒØŸ Ú†Ø·ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø´Ø±ÙˆØ¹ Ú©Ù†Ù…ØŸ">
                            Û±) Ø³ÙÛŒØ± Ø¢ÛŒÙ‡â€ŒÙ‡Ø§ ÛŒØ¹Ù†ÛŒ Ú†ÛŒØŸ Ú†Ø·ÙˆØ± Ø¨Ø§ÛŒØ¯ Ø´Ø±ÙˆØ¹ Ú©Ù†Ù…ØŸ
                        </button>
                        <button class="suggestion-btn w-full text-right text-[12px] sm:text-[13px] text-blue-600 hover:text-blue-700 px-3 py-2 rounded-lg cursor-pointer" data-suggestion="Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ ÙˆÛŒÚ˜Ù‡ Ú†ÛŒÙ‡ Ùˆ Ú©Ø¯ÙˆÙ… Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†Ù…ØŸ">
                            Û²) Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ ÙˆÛŒÚ˜Ù‡ Ú†ÛŒÙ‡ Ùˆ Ú©Ø¯ÙˆÙ… Ø±Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†Ù…ØŸ
                        </button>
                        <button class="suggestion-btn w-full text-right text-[12px] sm:text-[13px] text-blue-600 hover:text-blue-700 px-3 py-2 rounded-lg cursor-pointer" data-suggestion="Ù…Ù† ÙˆÙ‚Øª Ú©Ù… Ø¯Ø§Ø±Ù…ØŒ Ú†Ù‡ ÙØ¹Ø§Ù„ÛŒØª Ø³Ø±ÛŒØ¹ÛŒ Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù…ØŸ">
                            Û³) Ù…Ù† ÙˆÙ‚Øª Ú©Ù… Ø¯Ø§Ø±Ù…ØŒ Ú†Ù‡ ÙØ¹Ø§Ù„ÛŒØª Ø³Ø±ÛŒØ¹ÛŒ Ù…ÛŒâ€ŒØªÙˆÙ†Ù… Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù…ØŸ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

                // Attach click handlers to starter suggestions
                chatContainer.querySelectorAll('.suggestion-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const suggestion = btn.getAttribute('data-suggestion');
                        messageInput.value = suggestion;
                        autoResizeTextarea();
                        updateSendButton();
                        sendMessage();
                    });
                });

                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

        // New session functionality disabled for now
        // newSessionBtn.addEventListener('click', () => {
        //     aiClient.newSession();
        //     renderWelcome();
        //     messageInput.value = '';
        //     messageInput.style.height = 'auto';
        //     updateSendButton();
        // });

        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;

            const userMessage = document.createElement('div');
            userMessage.className = 'flex justify-start mb-4 message-enter';
            userMessage.innerHTML = `
                <div class="bg-gradient-to-r from-blue-500 to-purple-500 text-white px-4 sm:px-5 py-2 sm:py-3 rounded-2xl max-w-[85%] sm:max-w-[75%]">
                    <p class="text-[13px] sm:text-sm break-words">${escapeHtml(message)}</p>
                </div>
            `;
            chatContainer.appendChild(userMessage);
            messageInput.value = '';
            messageInput.style.height = 'auto';
            updateSendButton();
            chatContainer.scrollTop = chatContainer.scrollHeight;

            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex flex-col items-end mb-4 message-enter';
            messageDiv.style.display = 'none';
            const streamingContent = document.createElement('div');
            streamingContent.className = 'markdown-content bg-white px-4 sm:px-5 py-3 sm:py-4 rounded-2xl shadow-sm max-w-[85%] sm:max-w-[75%] text-[13px] sm:text-sm';
            messageDiv.appendChild(streamingContent);
            chatContainer.appendChild(messageDiv);

            showTyping();
            sendButton.disabled = true;

            try {
                const streamResponse = await aiClient.sendMessage(message, true);
                let fullText = '';
                let hasReceivedData = false;
                
                try {
                    for await (const chunk of streamResponse.chunks()) {
                        if (!hasReceivedData) {
                            hasReceivedData = true;
                            hideTyping();
                            messageDiv.style.display = 'block';
                        }
                        
                        if (streamResponse.sessionId && !aiClient.sessionId) {
                            aiClient.setSessionId(streamResponse.sessionId);
                        }
                        
                        fullText += chunk;
                        streamingContent.innerHTML = parseMarkdown(fullText);
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }
                    
                    if (!hasReceivedData && fullText.length === 0) {
                        hideTyping();
                        messageDiv.style.display = 'block';
                        streamingContent.innerHTML = '<p class="text-red-500">Ø®Ø·Ø§: Ù‡ÛŒÚ† Ù¾Ø§Ø³Ø®ÛŒ Ø§Ø² Ø³Ø±ÙˆØ± Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯. Ù„Ø·ÙØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.</p>';
                    }
                } catch (streamError) {
                    console.error('Error while reading stream:', streamError);
                    hideTyping();
                    messageDiv.style.display = 'block';
                    streamingContent.innerHTML = `<p class="text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø§Ø³Ø®: ${escapeHtml(streamError.message)}</p>`;
                    throw streamError;
                }
                
                hideTyping();

                const finalResponse = await streamResponse.getFullResponse();
                
                if (finalResponse.session_id) {
                    aiClient.setSessionId(finalResponse.session_id);
                }
                
                // Parse suggestions if present
                const suggestionsMatch = fullText.match(/Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ù‡Ø§ÛŒ Ø¨Ø¹Ø¯ÛŒ:\s*([\s\S]*?)(?:\n\n|$)/);
                if (suggestionsMatch) {
                    const mainText = fullText.substring(0, suggestionsMatch.index).trim();
                    const suggestionsText = suggestionsMatch[1].trim();
                    const suggestions = suggestionsText.split(/\n\s*(?=\d+\))/).filter(s => s.trim()).map(s => {
                        return s.replace(/^\d+\)\s*/, '').trim();
                    });

                    if (suggestions.length > 0) {
                        const suggestionsHtml = `
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <p class="text-[13px] sm:text-[12px] font-semibold text-gray-600 mb-2">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ù‡Ø§ÛŒ Ø¨Ø¹Ø¯ÛŒ:</p>
                                <div class="space-y-2">
                                    ${suggestions.map((s, idx) => `
                                        <button class="suggestion-btn w-full text-right text-[13px] sm:text-[12px] text-blue-600 hover:text-blue-700 hover:bg-blue-50 px-3 py-2.5 sm:py-2 rounded-lg transition-colors cursor-pointer" data-suggestion="${escapeHtml(s)}">
                                            ${idx + 1}) ${escapeHtml(s)}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                        streamingContent.innerHTML = parseMarkdown(mainText) + suggestionsHtml;
                        
                        messageDiv.querySelectorAll('.suggestion-btn').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const suggestion = btn.getAttribute('data-suggestion');
                                messageInput.value = suggestion;
                                messageInput.focus();
                                autoResizeTextarea();
                                sendMessage();
                            });
                        });
                    }
                }

                const msgId = finalResponse?.message_id || null;
                if (msgId) messageDiv.dataset.messageId = msgId;
                const contentForFeedback = (streamingContent.textContent || fullText || '').trim();
                const actions = createMessageActions(msgId, contentForFeedback);
                if (actions) messageDiv.appendChild(actions);

            } catch (error) {
                console.error('Streaming error:', error);
                hideTyping();
                messageDiv.style.display = 'block';
                
                try {
                    const response = await aiClient.sendMessage(message, false);
                    streamingContent.innerHTML = parseMarkdown(response.output);
                    
                    if (response.session_id) {
                        aiClient.setSessionId(response.session_id);
                    }
                } catch (fallbackError) {
                    streamingContent.innerHTML = 'Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±. Ù„Ø·ÙØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.';
                }
            } finally {
                sendButton.disabled = false;
            }
        }

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize chat on page load
        (async () => {
            await fetchFeedbackConfig();
            // Try to initialize from Safiranayeha parameter
            const initialized = await initializeChatFromSafiranayeha();
            
            // If no initialization happened, show default welcome (guest mode)
            if (!initialized) {
                sessionListCached = { sessions: [] };
                renderWelcome();
            }
            
            messageInput.focus();
        })();
    </script>
</body>

</html>
